{
  "name": "ğŸ“± SMS Customer Service - Yuboto",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sms-customer-service",
        "options": {
          "responseMode": "responseNode"
        }
      },
      "id": "sms-webhook",
      "name": "ğŸ“± SMS Webhook (Yuboto)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 400],
      "webhookId": "sms-customer-service"
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming SMS from Yuboto\nconst input = $input.first().json;\n\n// Yuboto sends SMS in various formats\nconst message = input.text || input.message || input.body || '';\nconst from = input.from || input.sender || input.msisdn || '';\nconst messageId = input.message_id || input.id || '';\n\n// Clean phone number\nconst cleanPhone = from.replace(/[^0-9+]/g, '');\n\n// Detect intent from message\nlet intent = 'general';\nconst lowerMessage = message.toLowerCase();\n\nif (lowerMessage.match(/Ï€Î±ÏÎ±Î³Î³ÎµÎ»|order|Ï€Î¿Ï ÎµÎ¯Î½Î±Î¹|Ï€Î¿Ï… ÎµÎ¹Î½Î±Î¹|tracking/)) {\n  intent = 'order_tracking';\n} else if (lowerMessage.match(/stock|Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿|Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼Î¿|Î­Ï‡ÎµÏ„Îµ|ÎµÏ‡ÎµÏ„Îµ|Ï…Ï€Î¬ÏÏ‡ÎµÎ¹/)) {\n  intent = 'stock_check';\n} else if (lowerMessage.match(/Ï„Î¹Î¼Î®|Ï„Î¹Î¼Î·|price|ÎºÏŒÏƒÏ„Î¿Ï‚|ÎºÎ¿ÏƒÏ„Î¿Ï‚|Ï€ÏŒÏƒÎ¿|Ï€Î¿ÏƒÎ¿/)) {\n  intent = 'price_inquiry';\n} else if (lowerMessage.match(/ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†|return|Î±ÎºÏÏ|Î±ÎºÏ…Ï|cancel/)) {\n  intent = 'return_request';\n}\n\n// Extract order number if present\nconst orderMatch = message.match(/#?(\\d{4,})/)\nconst orderNumber = orderMatch ? orderMatch[1] : null;\n\nreturn {\n  json: {\n    message,\n    from: cleanPhone,\n    messageId,\n    intent,\n    orderNumber,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "parse-sms",
      "name": "ğŸ” Parse SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 400]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "order",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "order_tracking",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "stock",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "stock_check",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "price",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "price_inquiry",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        }
      },
      "id": "route-intent",
      "name": "ğŸ”€ Route by Intent",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [600, 400]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $credentials.woocommerceApi.url }}/wp-json/wc/v3/orders/{{ $('ğŸ” Parse SMS').item.json.orderNumber }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "id": "woo-order",
      "name": "ğŸ›’ Get Order",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 250],
      "credentials": {
        "httpBasicAuth": {
          "id": "WOO_CREDENTIAL_ID",
          "name": "WooCommerce API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst phone = $('ğŸ” Parse SMS').item.json.from;\n\nif (response.statusCode === 404 || !response.body || response.body.code) {\n  return {\n    json: {\n      to: phone,\n      message: 'Î”ÎµÎ½ Î²ÏÎµÎ¸Î·ÎºÎµ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¹Î±. Î•Î»ÎµÎ³Î¾Ï„Îµ Ï„Î¿Î½ Î±ÏÎ¹Î¸Î¼Î¿ ÎºÎ±Î¹ ÏƒÏ„ÎµÎ¹Î»Ï„Îµ Î¾Î±Î½Î±.'\n    }\n  };\n}\n\nconst order = response.body;\nconst statusMap = {\n  'pending': 'Î‘Î½Î±Î¼Î¿Î½Î· Ï€Î»Î·ÏÏ‰Î¼Î·Ï‚',\n  'processing': 'Î•Ï„Î¿Î¹Î¼Î±Î¶ÎµÏ„Î±Î¹',\n  'on-hold': 'Î£Îµ Î±Î½Î±Î¼Î¿Î½Î·',\n  'completed': 'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¸Î·ÎºÎµ',\n  'shipped': 'Î‘Ï€ÎµÏƒÏ„Î±Î»Î·',\n  'cancelled': 'Î‘ÎºÏ…ÏÏ‰Î¸Î·ÎºÎµ'\n};\n\nconst status = statusMap[order.status] || order.status;\nconst trackingMeta = order.meta_data?.find(m => m.key.includes('tracking'));\nconst tracking = trackingMeta ? ` Tracking: ${trackingMeta.value}` : '';\n\n// SMS max 160 chars\nconst message = `Î Î±ÏÎ±Î³Î³ÎµÎ»Î¹Î± #${order.id}: ${status}. Î£Ï…Î½Î¿Î»Î¿: ${order.total}â‚¬.${tracking}`.substring(0, 160);\n\nreturn { json: { to: phone, message } };"
      },
      "id": "format-order-sms",
      "name": "ğŸ“ Format Order SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 250]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $credentials.woocommerceApi.url }}/wp-json/wc/v3/products",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "search",
              "value": "={{ $('ğŸ” Parse SMS').item.json.message }}"
            },
            {
              "name": "per_page",
              "value": "3"
            },
            {
              "name": "status",
              "value": "publish"
            }
          ]
        },
        "options": {}
      },
      "id": "woo-stock",
      "name": "ğŸ›’ Check Stock",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 400],
      "credentials": {
        "httpBasicAuth": {
          "id": "WOO_CREDENTIAL_ID",
          "name": "WooCommerce API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const products = $input.first().json;\nconst phone = $('ğŸ” Parse SMS').item.json.from;\n\nif (!products || products.length === 0) {\n  return {\n    json: {\n      to: phone,\n      message: 'Î”ÎµÎ½ Î²ÏÎµÎ¸Î·ÎºÎµ Ï€ÏÎ¿Î¹Î¿Î½. Î£Ï„ÎµÎ¹Î»Ï„Îµ Ï„Î¿ Î¿Î½Î¿Î¼Î± Ï„Î¿Ï… Ï€ÏÎ¿Î¹Î¿Î½Ï„Î¿Ï‚.'\n    }\n  };\n}\n\nconst inStock = products.filter(p => p.stock_status === 'instock');\n\nif (inStock.length > 0) {\n  const p = inStock[0];\n  const message = `${p.name}: ${p.price}â‚¬ - Î”Î™Î‘Î˜Î•Î£Î™ÎœÎŸ${p.stock_quantity ? ` (${p.stock_quantity} Ï„ÎµÎ¼.)` : ''}`.substring(0, 160);\n  return { json: { to: phone, message } };\n} else {\n  const p = products[0];\n  return { json: { to: phone, message: `${p.name}: Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î± Î¼Î· Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼Î¿. Î£Ï„ÎµÎ¹Î»Ï„Îµ NOTIFY Î³Î¹Î± ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î·ÏƒÎ·.` } };\n}"
      },
      "id": "format-stock-sms",
      "name": "ğŸ“ Format Stock SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "jsCode": "const phone = $('ğŸ” Parse SMS').item.json.from;\nconst message = $('ğŸ” Parse SMS').item.json.message;\n\n// For price inquiries, we need product search\n// This is a simplified response asking for more info\nreturn {\n  json: {\n    to: phone,\n    message: 'Î“Î¹Î± Ï„Î¹Î¼ÎµÏ‚, ÏƒÏ„ÎµÎ¹Î»Ï„Îµ Ï„Î¿ Î±ÎºÏÎ¹Î²ÎµÏ‚ Î¿Î½Î¿Î¼Î± Î® ÎºÏ‰Î´Î¹ÎºÎ¿ Ï€ÏÎ¿Î¹Î¿Î½Ï„Î¿Ï‚. Î•Ï€Î¹ÏƒÎºÎµÏ†Î¸ÎµÎ¹Ï„Îµ: eshop.gr/products'\n  }\n};"
      },
      "id": "format-price-sms",
      "name": "ğŸ“ Format Price SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 550]
    },
    {
      "parameters": {
        "jsCode": "const phone = $('ğŸ” Parse SMS').item.json.from;\nconst message = $('ğŸ” Parse SMS').item.json.message;\n\n// Default response for general inquiries\nreturn {\n  json: {\n    to: phone,\n    message: 'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„Î¿Ï…Î¼Îµ! Î£Ï„ÎµÎ¹Î»Ï„Îµ: Î Î‘Î¡Î‘Î“Î“Î•Î›Î™Î‘+Î±ÏÎ¹Î¸Î¼Î¿ Î³Î¹Î± tracking, STOCK+Ï€ÏÎ¿Î¹Î¿Î½ Î³Î¹Î± Î´Î¹Î±Î¸ÎµÏƒÎ¹Î¼Î¿Ï„Î·Ï„Î±. Î— ÎºÎ±Î»ÎµÏƒÏ„Îµ 210-Î§Î§Î§Î§Î§Î§Î§.'\n  }\n};"
      },
      "id": "format-general-sms",
      "name": "ğŸ“ Format General SMS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 700]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://omni.yuboto.com/api/v1/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{ $credentials.yubotoApi.apiKey }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": \"{{ $json.to }}\",\n  \"text\": \"{{ $json.message }}\",\n  \"from\": \"ESHOP\"\n}",
        "options": {}
      },
      "id": "send-sms",
      "name": "ğŸ“¤ Send SMS (Yuboto)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"SMS queued\"\n}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "ğŸ“¤ Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1500, 400]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "YOUR_GOOGLE_SHEET_ID"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "SMS_Log"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $now.toISO() }}",
            "From": "={{ $('ğŸ” Parse SMS').item.json.from }}",
            "Message In": "={{ $('ğŸ” Parse SMS').item.json.message }}",
            "Intent": "={{ $('ğŸ” Parse SMS').item.json.intent }}",
            "Response": "={{ $json.message }}"
          }
        },
        "options": {}
      },
      "id": "log-sheets",
      "name": "ğŸ“Š Log to Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1300, 600],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GOOGLE_CREDENTIAL_ID",
          "name": "Google Sheets"
        }
      }
    }
  ],
  "connections": {
    "ğŸ“± SMS Webhook (Yuboto)": {
      "main": [
        [
          {
            "node": "ğŸ” Parse SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Parse SMS": {
      "main": [
        [
          {
            "node": "ğŸ”€ Route by Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Route by Intent": {
      "main": [
        [
          {
            "node": "ğŸ›’ Get Order",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ›’ Check Stock",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“ Format Price SMS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“ Format General SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ Get Order": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Order SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Order SMS": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send SMS (Yuboto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ Check Stock": {
      "main": [
        [
          {
            "node": "ğŸ“ Format Stock SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Stock SMS": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send SMS (Yuboto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format Price SMS": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send SMS (Yuboto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Format General SMS": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Send SMS (Yuboto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¤ Send SMS (Yuboto)": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Respond OK",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“Š Log to Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "SMS",
      "createdAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "Yuboto",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
